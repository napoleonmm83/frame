<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
  <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'" />
    <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'">
    <title>Hello World!</title>
    <link rel="stylesheet" href="css/style.css">

  </head>
  <body bgcolor="#000">
    <div id="frame" class="frame" >
    text-align:center;">
     <img id="thumbnail" src="" class="pic">
  </div>

    <!-- You can also require other files to run in this process -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
  </body>
    <script src="./renderer.js"></script>

<script>

const got = require("got");
const { createWriteStream } = require("fs");
var fs = require('fs');

var firebaseConfig = {
  apiKey: "AIzaSyA3oQk3_wKpMJP2NHeBtY0QYH5cLQlzPbM",
    authDomain: "my-piframe.firebaseapp.com",
    databaseURL: "https://my-piframe.firebaseio.com",
    projectId: "my-piframe",
    storageBucket: "my-piframe.appspot.com",
};
firebase.initializeApp(firebaseConfig);

// Get a reference to the storage service, which is used to create references in your storage bucket
var storage = firebase.storage();
var storageRef = storage.ref();
// Create a reference under which you want to list
var listRef = storageRef.child('images');


var dirPath = './images/';
let content = "";
local_array = [];
firebase_array = [];

fs.readdir(dirPath, (err, dir)=>{

  for(var i=0; i<dir.length; i++){
      let fileName = dir[i];
    var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif)$/i;
    if(!allowedExtensions.exec(fileName)){
  }else{
      let filePath=dirPath+"/"+fileName;
     // console.log("A: "+fileName);
      local_array.push(fileName);
}
  }

})

// Find all the prefixes and items.
listRef.listAll().then(function(res) {
  res.prefixes.forEach(function(folderRef) {
    // All the prefixes under listRef.
    // You may call listAll() recursively on them.
  });

  res.items.forEach(function(itemRef) {




    storageRef.child(itemRef.location.path).getDownloadURL().then(function(url) {
    console.log(url)

    const fileName = "./"+itemRef.location.path;

    const downloadStream = got.stream(url);
    const fileWriterStream = createWriteStream(fileName);

    downloadStream
      .on("downloadProgress", ({ transferred, total, percent }) => {
        const percentage = Math.round(percent * 100);
      //  console.error(`progress: ${transferred}/${total} (${percentage}%)`);
      })
      .on("error", (error) => {
        console.error(`Download failed: ${error.message}`);
      });

    fileWriterStream
      .on("error", (error) => {
        console.error(`Could not write file to system: ${error.message}`);
      })
      .on("finish", () => {
        console.log(`File downloaded to ${fileName}`);
      });

    downloadStream.pipe(fileWriterStream);


});
  });
}).catch(function(error) {
  // Uh-oh, an error occurred!
}).then(function(newResult) {
  console.log(local_array);

    console.log(firebase_array);
  console.log(local_array.lenght);




if (typeof local_array !== 'undefined' && local_array.length == 0){
  console.log("start download")
  listRef.listAll().then(function(res) {
    res.prefixes.forEach(function(folderRef) {
      // All the prefixes under listRef.
      // You may call listAll() recursively on them.
    });

    res.items.forEach(function(itemRef) {




      storageRef.child(itemRef.location.path).getDownloadURL().then(function(url) {
      console.log(url)

      const fileName = "./"+itemRef.location.path;

      const downloadStream = got.stream(url);
      const fileWriterStream = createWriteStream(fileName);

      downloadStream
        .on("downloadProgress", ({ transferred, total, percent }) => {
          const percentage = Math.round(percent * 100);
        //  console.error(`progress: ${transferred}/${total} (${percentage}%)`);
        })
        .on("error", (error) => {
          console.error(`Download failed: ${error.message}`);
        });

      fileWriterStream
        .on("error", (error) => {
          console.error(`Could not write file to system: ${error.message}`);
        })
        .on("finish", () => {
          console.log(`File downloaded to ${fileName}`);
        });

      downloadStream.pipe(fileWriterStream);


  });
    });
  }).catch(function(error) {
    // Uh-oh, an error occurred!
  })
} else{

  local_array.forEach(filechecker)

function filechecker(element){
  console.log(element)

  var arry_includes = firebase_array.includes(element)

  if ( arry_includes == true){
    //// everything ok dont need to to anything
  }

  if ( arry_includes == false){
  //file was removed in cloud can dlet also local_array
  const path = './images/'+element;
  try {
    fs.unlinkSync(path)
    //file removed
  } catch(err) {
    console.error(err)
  }
  }


}




}







})



















</script>



  </body>
</html>
